<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>

<script type="text/javascript">
//This page is a result of an autogenerated content made by running test.html with firefox.
function domo(){
 
   // Binding keys
   $('*').bind('keydown', 'Ctrl+a', function assets() {
       window.location.href = BASE_URL + '/administrator/devis/adds/<?php $this->uri->segment(4) ?>';
       return false;
   });

   $('*').bind('keydown', 'Ctrl+f', function assets() {

       $('#sbtn').trigger('click');
       return false;
   });

   $('*').bind('keydown', 'Ctrl+x', function assets() {
       $('#reset').trigger('click');
       return false;
   });

   $('*').bind('keydown', 'Ctrl+b', function assets() {

       $('#reset').trigger('click');
       return false;
   });
}

jQuery(document).ready(domo);
</script>
<style type="text/css">
  tr:hover td{
    background-color: #ccc !important;
  }
</style>
<!-- Content Header (Page header) -->
<section class="content-header">
   <h1>
      Devis<small></small>
   </h1>
   <h5 class="widget-user-desc"><i class="label bg-yellow"><?= $devis_counts; ?> &nbsp; élément<?php if($devis_counts > 1)echo 's'; ?></i></h5>
   <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-dashboard"></i> Accueil</a></li>
      <li class="active">Devis</li>
   </ol>
</section>
<!-- Main content -->
<section class="content">
   <div class="row" >
      
      <div class="col-md-12">
         <div class="box box-warning">
            <div class="box-body ">
               <!-- Widget: user widget style 1 -->
               <div class="box box-widget widget-user-2">
                  <!-- Add the bg color to the header using any of the bg-* classes -->
                  <form name="form_devis" id="form_fiche_travail" action="<?= base_url('administrator/devis/index/'.$this->uri->segment(4)); ?>">
                        <div class="widget-user-header ">
                         <div class="row pull-center" style="margin-left:5%">
                          <div  class="col-md-8">
                             <div class="col-sm-4 padd-left-0  " >
                                <input type="text" class="form-control" name="q" id="filter" placeholder="<?= cclang('filter'); ?>" value="<?= $this->input->get('q'); ?>">
                             </div>
                             <div class="col-sm-3 padd-left-0 " >
                                <select type="text" class="form-control chosen chosen-select" name="f" id="field" >
                                   <option value=""><?= cclang('all'); ?></option>
                                    <option <?= $this->input->get('f') == 'CODE_DEVIS' ? 'selected' :''; ?> value="CODE_DEVIS">Devis</option>
                                    <option <?= $this->input->get('f') == 'TITRE_DEVIS' ? 'selected' : ''; ?> value="TITRE_DEVIS">Description</option>
                                    <option <?= $this->input->get('f') == 'DATE_CREATION_DEVIS' ? 'selected' : ''; ?> value="DATE_CREATION_DEVIS">Date création</option>
                                  </select>
                             </div>
                             <div class="col-sm-1 padd-left-0 ">
                                <button type="submit" class="btn btn-flat" name="sbtn" id="sbtn" value="Apply" title="Rechercher">
                                <i class="fa fa-search"></i>
                                </button>
                             </div>
                             <div class="col-sm-1 padd-left-0 ">
                                <a class="btn btn-default btn-flat" name="reset" id="reset" value="Apply" href="<?= base_url('administrator/devis/index/'.$this->uri->segment(4));?>" title="<?= cclang('reset_filter'); ?>">
                                <i class="fa fa-undo"></i>
                                </a>
                             </div>
                          </div>
                            <?php is_allowed('devis_add', function(){?>
                            <a class="btn btn-flat btn-success btn_add_new" id="btn_add_new" title="" href="<?=  site_url('administrator/devis/add/index/'.$this->uri->segment(4)); ?>"><i class="fa fa-plus" ></i></a>
                            <?php }) ?>
                        </div>
                      </div>
                  </form>

                  <div class="table-responsive"> 
                    <table class="table table-bordered table-striped dataTable">
                     <thead>
                        <tr>
                           <th>&#8470; &nbsp;</th>
                           <th>&#8470; &nbsp;du devis</th>
                           <th>Description</th>
                           <th>Client</th>
                           <th>Par</th>
                           <th>Date de création</th>
                           <th>Status</th>
                           <th>Action</th>
                        </tr>
                     </thead>
                     <tbody id="tbody_devis">
                     <?php $i = 0;
                     foreach($deviss as $devis): 
                      $i++;
                      ?>
                        <tr>
                          <td><?= $i?></td>
                          <td><?= _ent($devis->CODE_DEVIS); ?></td> 
                          <td><?= _ent($devis->TITRE_DEVIS); ?></td> 
                          <td><?= _ent($devis->NOM_CLIENT); ?></td>
                          <td><?= _ent($devis->full_name); ?></td> 
                          <td><?= _ent($devis->DATE_CREATION_DEVIS); ?></td>
                          <td>
                          <?php 
                           if($devis->STATUT_DEVIS==1){
                              echo '<i style="background-color:green" class="label">Approuvé</i>';
                           }elseif($devis->STATUT_DEVIS==2){
                              echo '<i class="label bg-red">Annuler</i>';
                           }else{
                              echo '<i class="label bg-yellow">En attente</i>';
                           }
                         ?>
                         </td>  
                         <td width="150">
                          <?php is_allowed('devis_view', function() use ($devis){?> 
                            <a title="voir détail du devis" href="<?= site_url('administrator/devis/view/'.$this->uri->segment(4).'/' . $devis->ID_DEVIS); ?>" class="btn btn-warning btn-xs"><i class="fa fa-eye "></i> 
                            </a>
                          <?php }) ?>
                          <?php if($devis->STATUT_DEVIS == 0 and $devis->TOTAL_FINAL_DEVIS > 0) { ?>
                            <?php is_allowed('devis_approuved', function() use ($devis){?>
                            <a class="btn btn-flat btn-primary btn_action  btn-xs" id="btn_approuved<?php echo $devis->ID_DEVIS; ?>" title="Approuver un devis">
                            <i class="fa fa-check" ></i></a>
                            <?php }) ?>
                          <?php }?> 
                          <input type="hidden" id="code_dev<?php echo $devis->CODE_DEVIS; ?>" value="<?php echo $devis->CODE_DEVIS; ?>" name="code_dev">
                          <input type="hidden" id="devis_id<?php echo $devis->ID_DEVIS; ?>" value="<?php echo $devis->ID_DEVIS; ?>" name="id_devis">
                          <input type="hidden" id="store<?php echo $devis->ID_DEVIS; ?>" value="<?php echo $this->uri->segment(4); ?>" name="store">
                          <?php if($devis->STATUT_DEVIS == 1 ) { ?>
                              <?php is_allowed('devis_approuved', function() use ($devis){?>
                              <a title="Désapprouver ce devis" href="javascript:void(0);" data-href="<?= site_url('administrator/devis/desapprouved_devis/'.$this->uri->segment(4).'/' . $devis->ID_DEVIS.'/'.$devis->CODE_DEVIS); ?>" class="btn btn-primary btn-xs desapprouver"><i class="fa fa-undo"></i></a>
                               <?php }) ?>
                            <?php } ?>
                            <?php if($devis->STATUT_DEVIS == 2 ) { ?>
                              <?php is_allowed('devis_delete_cancel', function() use ($devis){?>
                              <a title="Desannuler ce devis" href="javascript:void(0);" data-href="<?= site_url('administrator/devis/to_recancel/'.$this->uri->segment(4).'/' . $devis->ID_DEVIS); ?>" class="btn btn-warning btn-xs recancel-data"><i class="fa fa-undo"></i></a>
                              <?php }) ?>
                              <?php is_allowed('devis_delete', function() use ($devis){?>
                              <a title="Supprimer ce devis" href="javascript:void(0);" data-href="<?= site_url('administrator/devis/delete/'.$this->uri->segment(4).'/' . $devis->ID_DEVIS); ?>" class="btn btn-danger btn-xs remove-data"><i class="fa fa-close"></i></a>
                               <?php }) ?>
                            <?php }else{ ?>
                              <?php is_allowed('devis_view', function() use ($devis){?>
                                <a  title="Créer un proforma" class="btn btn-info btn-xs" data-toggle="modal" data-target="#myModal<?php echo $devis->ID_DEVIS; ?>"><i class="fa fa-print"></i></a>
                              <?php }) ?>
                              <?php is_allowed('devis_update', function() use ($devis){?>
                              <a title="Modification du devis" href="<?= site_url('administrator/devis/edit/'.$this->uri->segment(4).'/' . $devis->ID_DEVIS); ?>" class="btn btn-default btn-xs"><i class="fa fa-edit "></i> </a>
                              <?php }) ?>
                              <?php is_allowed('devis_delete_cancel', function() use ($devis){?>
                              <a title="Annuler ce devis" href="javascript:void(0);" data-href="<?= site_url('administrator/devis/to_cancel/'.$this->uri->segment(4).'/' . $devis->ID_DEVIS); ?>" class="btn btn-danger btn-xs remove-data"><i class="fa fa-close"></i></a>
                              <?php }) ?>
                            <?php } ?>
                           </td>
                        </tr>





                <!-- Modal -->
                <div id="myModal<?php echo $devis->ID_DEVIS; ?>" class="modal fade" role="dialog">
                  <div class="modal-dialog">
                    <!-- Modal content-->
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Créer un proforma</h4>
                      </div>  
                      <div class="modal-body"> 
                      <input type="hidden" class='id_devis<?php echo $devis->ID_DEVIS; ?>'  name="id_devis" value="<?php echo $devis->ID_DEVIS; ?>">
                      <div class="row">
                          <div class="form-group ">
                            <label for="TITRE_FICHE" class="col-sm-2 control-label">Titre  
                            <i class="required">*</i>
                            </label>
                            <div class="col-sm-8">
                            
                                <input type="text" class="form-control" name="titre_proforma" id="TITRE_FICHE<?php echo $devis->ID_DEVIS;?>" placeholder="Entrer un titre pour proforma" value="">
                                <small class="info help-block">
                                </small>
                            </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="form-group ">
                            <label for="quantite" class="col-sm-2 control-label">Quantité
                            <i class="required">*</i>
                            </label>
                            <div class="col-sm-8">
                              <input type="number" class="form-control" name="quantitee" id="quantite<?php echo $devis->ID_DEVIS;?>" placeholder="Entrer quantité à produire" value="">
                                <small class="info help-block">
                                </small>
                            </div>
                         </div>
                      </div>
                      <div class="row">
                        <div class="form-group ">
                          <label for="garantie" class="col-md-2 control-label">Remise : </label>
                          <div class="col-md-5 rmse">
                            <select  class="form-control application" name="application" id="application<?php echo $devis->ID_DEVIS; ?>">
                              <option value="" selected disabled>---Sélectionner une remise--- </option> 
                              <option value="pourcentage">Pourcentage</option>
                              <option value="espece">Espèce</option>
                            </select>
                          </div>
                          <div id="espece_position" class="col-md-3">
                            <input type="number" value="0" min="1" id="remise_value<?php echo $devis->ID_DEVIS; ?>" class="form-control">
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
                      <button data-stype='back' class="btn btn-primary btn_save btn_action btn_save_back verifier"><input type="hidden" value="<?php echo $devis->ID_DEVIS;?>" name="btnsend">Envoyer</button>
                    </div>
                  </div>
                </div>
              </div>


   
 <script type="text/javascript">

  $(document).ready(function(){
   
       $('#btn_approuved<?php echo $devis->ID_DEVIS; ?>').click(function(){

        var id_devis = $('#devis_id<?php echo $devis->ID_DEVIS; ?>').val();
        var store = $('#store<?php echo $devis->ID_DEVIS; ?>').val();
        var code_dev = $('#code_dev<?php echo $devis->CODE_DEVIS; ?>').val();
        swal({
            title: "Êtes-vous sûr de vouloir Approuver",
            text: "Ce devis deviendra une fiche de travail",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "oui approuvez-le",
            cancelButtonText: "no annuler plx",
            closeOnConfirm: true,
            closeOnCancel: true
          },
          function(isConfirm){
            if (isConfirm) {
              window.location.href = '<?=base_url()?>administrator/devis/approuved_devis/'+store+'/'+id_devis+'/'+code_dev;
            }
          });
    
        return false;
      }); /*end btn approuver*/

   }); 

 </script>



                      <?php endforeach; ?>


                      <?php if ($devis_counts == 0) :?>
                         <tr style="color:red; text-align: center;">
                           <td colspan="100">
                           Pas du contenu à afficher
                           </td>
                         </tr>
                      <?php endif; ?>

                      </tbody>
                    </table>
                  </div>
               </div>
               <hr>
               <div class="row">
                  <div class="col-md-8">
                  </div>                
                  <div class="col-md-4">
                     <div class="dataTables_paginate paging_simple_numbers pull-right" id="example2_paginate" >
                        <?= $pagination; ?>
                     </div>
                  </div>
               </div>

                   <?= form_open('', [
                                  'name'    => 'add_devis_form', 
                                  'class'   => 'add_devis_form', 
                                  'id'      => 'add_devis_form', 
                                  'enctype' => 'multipart/form-data', 
                                  'method'  => 'POST'
                                  ]); ?>
                   <input type="hidden" value="" name="ids_devis" id="ids_devis">                         
                   <input type="hidden" value="" name="titre" id="titre">
                   <input type="hidden" value="" name="qte" id="qte">
                   <input type="hidden" value="" name="remise_val" id="remise_val">
                   <input type="hidden" value="" name="selected_rems" id="selected_rems">
                   <input type="hidden" value="<?=$this->uri->segment(4)?>" name="store">
                  <?= form_close(); ?>

               </div>
            </div>
            <!--/box body -->
         <!--/box -->
      </div>
   </div>
</section>
<!-- /.content -->

<!-- Page script -->
<script>
  $(document).ready(function(){

  $('.verifier').click(function(){

    var btnsend_value = $(this).find('input[name=btnsend]').val();
    var id_divus = $('.id_devis'+btnsend_value).val();
    var fiche = $('#TITRE_FICHE'+btnsend_value).val();
    var quantite = $('#quantite'+btnsend_value).val();
    var remise_applik = $('#remise_value'+btnsend_value).val();
    var etat_value = $("#application"+btnsend_value).children("option:selected").val();
    var pos='pourcentage';

    if(fiche ==''){
      sweetAlert('Donner un titre de fiche');
       return false;
    }else if(etat_value == pos && remise_applik > 100){
      sweetAlert('Le pourcentage ne peut pas etre supérieur à 100');
       return false;
    }else if(quantite ==''){
      sweetAlert('Donner la quantité à produire');
       return false;
    }else{

      $('#ids_devis').val(id_divus);
      $('#titre').val(fiche);
      $('#qte').val(quantite);
      $('#remise_val').val(remise_applik);
      $('#selected_rems').val(etat_value);

        var add_devis_form = $('#add_devis_form');
        var data_post = add_devis_form.serializeArray();
        var save_type = $(this).attr('data-stype');

        data_post.push({
          name: 'save_type',
          value: save_type
        });

        $('.loading').show();

        $.ajax({
             url: BASE_URL + '/administrator/proforma/add_save/<?=$this->uri->segment(4)?>',
            type: 'POST',
            dataType: 'json',
            data: data_post,
          })

          .done(function(res) {

            if (res.success) {

              if (save_type == 'back') {
                window.location.href = res.redirect;
                return;
              }

              $('.message').printMessage({
                message: res.message
              });
              $('.message').fadeIn();
              resetForm();
              $('.chosen option').prop('selected', false).trigger('chosen:updated');

            } else {

              $('.message').printMessage({
                message: res.message,
                type: 'warning'
              });

            }
          })

          .fail(function() {

            $('.message').printMessage({
              message: 'Error save data',
              type: 'warning'
            });
          })

          .always(function() {

            $('.loading').hide();
            $('html, body').animate({
              scrollTop: $(document).height()
            }, 2000);

          });

      }

      return false;

    });





    $('.desapprouver').click(function(){

      var url = $(this).attr('data-href');

      swal({
          title: "Êtes-vous sûr de vouloir Désapprouver",
          text: "La fiche de travail correspondante sera supprimé",
          type: "warning",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "oui desapprouvez-le",
          cancelButtonText: "no annuler plx",
          closeOnConfirm: true,
          closeOnCancel: true
        },
        function(isConfirm){
          if (isConfirm) {
            document.location.href = url;            
          }
        });

      return false;
    });
   
    $('.remove-data').click(function(){

      var url = $(this).attr('data-href');

      swal({
          title: "Etes-vous sûr",
          text: "les données à supprimer ne peuvent pas être restaurées",
          type: "warning",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "oui supprimez-le",
          cancelButtonText: "no annuler plx",
          closeOnConfirm: true,
          closeOnCancel: true
        },
        function(isConfirm){
          if (isConfirm) {
            document.location.href = url;            
          }
        });

      return false;
    });

    $('.recancel-data').click(function(){

      var url = $(this).attr('data-href');

      swal({
          title: "Etes-vous sûr",
          text: "les données annuler seront restaurées",
          type: "warning",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "oui restaurez-le",
          cancelButtonText: "no annuler plx",
          closeOnConfirm: true,
          closeOnCancel: true
        },
        function(isConfirm){
          if (isConfirm) {
            document.location.href = url;            
          }
        });

      return false;
    });


  /*end appliy click*/
   });

</script>