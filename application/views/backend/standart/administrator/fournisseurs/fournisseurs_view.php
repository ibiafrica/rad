<!-- Fine Uploader Gallery CSS file
    ====================================================================== -->
<link href="<?= BASE_ASSET; ?>/fine-upload/fine-uploader-gallery.min.css" rel="stylesheet">
<!-- Fine Uploader jQuery JS file
    ====================================================================== -->
<script src="<?= BASE_ASSET; ?>/fine-upload/jquery.fine-uploader.js"></script>
<?php $this->load->view('core_template/fine_upload'); ?>
<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>
<script type="text/javascript">
//This page is a result of an autogenerated content made by running test.html with firefox.
function domo(){
 
   // Binding keys
   $('*').bind('keydown', 'Ctrl+e', function assets() {
      $('#btn_edit').trigger('click');
       return false;
   });

   $('*').bind('keydown', 'Ctrl+x', function assets() {
      $('#btn_back').trigger('click');
       return false;
   });
    
}

// kkkk
jQuery(document).ready(domo);
</script>
<!-- Content Header (Page header) -->
<section class="content-header">
   <h1>
      Fournisseurs      <small><?= cclang('detail', ['Fournisseurs']); ?> </small>
   </h1>
   <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
      <li class=""><a  href="<?= site_url('administrator/fournisseurs'); ?>">Fournisseurs</a></li>
      <li class="active"><?= cclang('detail'); ?></li>
   </ol>
</section>
<!-- Main content -->
<section class="content">
   <div class="row" >
     
      <div class="col-md-12">
         <div class="box box-warning">
            <div class="box-body ">

               <!-- Widget: user widget style 1 -->
               <div class="box box-widget widget-user-2">
                  <!-- Add the bg color to the header using any of the bg-* classes -->
                  <div class="widget-user-header ">
                    
                     <div class="widget-user-image">
                        <img class="img-circle" src="<?= BASE_ASSET; ?>/img/view.png" alt="User Avatar">
                     </div>
                     <!-- /.widget-user-image -->
                     <h3 class="widget-user-username">Fournisseurs</h3>
                     <h5 class="widget-user-desc">Detail Fournisseurs</h5>
                     <hr>
                  </div>

                  <div class="bd-example bd-example-tabs">
                    <ul class="nav nav-tabs">
                        <li class="active"> 
                          <a href="#Identification" data-toggle="tab" aria-expanded="true">
                            <i class="fa fa-tag"></i>
                            Information du fournisseur 
                          </a> 
                        </li>
                        <li class=""> 
                          <a href="#fiche" data-toggle="tab" aria-expanded="true">
                            <i class="fa fa-archive"></i>
                            Dossier 
                          </a> 
                        </li>
                        <li class=""> 
                          <a href="#approvisionnement" data-toggle="tab" aria-expanded="true">
                            <i class="fa fa-truck default"></i>
                            Approvisionnement 
                          </a> 
                        </li>
                          
                    </ul>
                    <hr>
                  <div class="tab-content" id="nav-tabContent">
                      <div class="tab-pane active" id="Identification">
                        <div class="form-horizontal" name="form_fournisseurs" id="form_fournisseurs" >
                          <div class="form-group ">
                              <label for="content" class="col-sm-3"style="margin-left: 40px"> Nom du fournisseur </label>
                              <div class="col-sm-7">
                                 <?= _ent($fournisseurs->NOM); ?>
                              </div>
                          </div>                                   
                          <div class="form-group ">
                              <label for="content" class="col-sm-3 "style="margin-left: 40px">Téléphone</label>
                              <div class="col-sm-7">
                                 <?= _ent($fournisseurs->TEL); ?>
                              </div>
                          </div>           
                          <div class="form-group ">
                              <label for="content" class="col-sm-3 "style="margin-left: 40px">Email </label>
                              <div class="col-sm-7">
                                 <?= _ent($fournisseurs->EMAIL); ?>
                              </div>
                          </div>                 
                          <div class="form-group ">
                              <label for="content" class="col-sm-3"style="margin-left: 40px">Boite postal </label>
                              <div class="col-sm-7">
                                 <?= _ent($fournisseurs->BP); ?>
                              </div>
                          </div>
                          <div class="form-group ">
                              <label for="content" class="col-sm-3"style="margin-left: 40px">Compte du fournisseur </label>
                              <div class="col-sm-7">
                                 <?= _ent($fournisseurs->NUMBER_COMPTE); ?>
                              </div>
                          </div>                                  
                          <div class="form-group ">
                              <label for="content" class="col-sm-3"style="margin-left: 40px">Description </label>
                              <div class="col-sm-7">
                                 <?= _ent($fournisseurs->DESCRIPTION); ?>
                              </div>
                          </div>               
                          <div class="view-nav">
                              <?php is_allowed('fournisseurs_update', function() use ($fournisseurs){?>
                              <a class="btn btn-flat btn-info btn_edit btn_action" id="btn_edit" data-stype='back' title="modifier" href="<?= site_url('administrator/fournisseurs/edit/'.$this->uri->segment(4).'/'.$this->uri->segment(5)); ?>"><i class="fa fa-edit" ></i> Mise à jour </a>
                              <?php }) ?>
                              <a class="btn btn-flat btn-default btn_action" id="btn_back" title="Retour" href="<?= site_url('administrator/fournisseurs/index/'.$this->uri->segment(4).''); ?>"><i class="fa fa-undo" ></i>Retour</a>
                           </div>

                          </div>
                              <!-- fin identification -->
                        </div>
                        <div class="tab-pane" id="fiche">
                          <div class="table-responsive"> 
                          <table class="table table-bordered table-striped dataTable">
                             <thead>
                                <tr class="">
                                 
                                   <th>Non du fournisseur</th>
                                   <th>Nom du fiche</th>
                                   <th>N° du fiche</th>
                                   <th>Fichier du fournisseur</th>
                                   <th>Date</th>
                                   <th>Par</th>
                                   <th>Action</th>
                                </tr>
                             </thead>
                            <tbody id="tbody_fournisseurs">
                               <?php foreach($fournisseurs_files as $fournisseurs_file): 
                                $auth_user = $this->model_registers->getOne('aauth_users',array('id'=>$fournisseurs_file->AUTHOR_FILE));
                                ?>
                                <tr>
                                   <td><?= _ent($fournisseurs_file->NOM);?></td>
                                   <td><?= _ent($fournisseurs_file->NAME_FILE);?></td>
                                   <td><?= _ent($fournisseurs_file->NUMERO_FILE); ?></td> 
                                   <td> <?php if (is_image($fournisseurs_file->PATH_FILE)): ?>

                                      <a class="fancybox" rel="group" href="<?= BASE_URL . 'uploads/fournisseurs_file/' . $fournisseurs_file->PATH_FILE; ?>">
                                        <img src="<?= BASE_URL . 'uploads/fournisseurs_file/' . $fournisseurs_file->PATH_FILE; ?>" class="image-responsive" alt="image fournisseurs" title="fournisseurs file" width="40px">
                                      </a>
                                      <?php else: ?>
                                      <label>
                                        <a href="<?= BASE_URL . 'administrator/file/download/fournisseurs_file/' . $fournisseurs_file->PATH_FILE; ?>">
                                         <img src="<?= get_icon_file($fournisseurs_file->PATH_FILE); ?>" class="image-responsive" alt="image fournisseurs" title="fournisseurs file" width="40px"> 
                                       <?= $fournisseurs_file->PATH_FILE ?>
                                       </a>
                                       </label>
                                      <?php endif; ?>
                                    </td> 
                                    <td><?= _ent($fournisseurs_file->DATE_CREATION_FILE); ?></td> 
                                    <td><?= $auth_user['username']; ?></td> 
                                  
                                   <td width="200">
                                      <?php is_allowed('fournisseurs_file_delete', function() use ($fournisseurs_file){?>
                                      <a href="javascript:void(0);" data-href="<?= site_url('administrator/fournisseurs/delete_file/'.$this->uri->segment(4).'/' . $fournisseurs_file->ID_FILE); ?>" title="Supprimer la fiche" class="btn btn-danger remove-data btn-xs"><i class="fa fa-close"></i></a>
                                       <?php }) ?>
                                      <?php is_allowed('fournisseurs_file_update', function() use ($fournisseurs_file){?>
                                        <button type="button" class="btn btn-default btn-xs" title="Editer la fiche" onclick="appel_modal(this.id)" id="<?=$fournisseurs_file->ID_FILE?>"><i class="fa fa-edit"></i></button>
                                      <?php }) ?>
                                    </td>
                                  </tr>

    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
      <div class="modal-dialog">
        <?= form_open('', [
                            'name'    => 'form_fournisseurs_file', 
                            'class'   => 'form-horizontal', 
                            'id'      => 'form_fournisseurs_file', 
                            'enctype' => 'multipart/form-data', 
                            'method'  => 'POST'
                            ]); ?>
        <div class="modal-content">
          <div class="modal-header" >
              <h4> Modification du fiche fournisseur</h4> 
          </div>
          <div class="modal-body">
              <div class="form-group">
                <label for="NAME_FILE" class="col-sm-4 control-label">Nom de la fiche 
                  <i class="required">*</i> 
                </label>
                <div class="col-sm-8">
                  <input type="text" class="form-control" id="NAME_FILE" placeholder="Nom de la fiche" name="NAME_FILE" value="<?= set_value('NAME_FILE', $fournisseurs_file->NAME_FILE); ?>">
                </div>
              </div>
              <hr>
               <div class="form-group">
                <label for="NUMERO_FILE" class="col-sm-4 control-label">Numéro de la fiche 
                  <i class="required">*</i> 
                </label>
                <div class="col-sm-8">
                  <input type="text" class="form-control" id="NUMERO_FILE" placeholder="Numéro de la fiche" name="NUMERO_FILE" value="<?= set_value('NUMERO_FILE', $fournisseurs_file->NUMERO_FILE); ?>">
                </div>
              </div>
              <input type="hidden" name="REF_ID_FILE" id="REF_ID_FILE" value="">
                    <div class="form-group " style="height:300px;">
                            <label for="PATH_FILE" class="col-sm-4 control-label">
                            <i class="required"></i>
                            </label>
                            <div class="col-sm-5">
                                <div id="fournisseurs_file_PATH_FILE_galery"></div>
                                <input class="data_file" name="fournisseurs_file_PATH_FILE_uuid" id="fournisseurs_file_PATH_FILE_uuid" type="hidden" value="<?= set_value('fournisseurs_file_PATH_FILE_uuid'); ?>">
                                <input class="data_file" name="fournisseurs_file_PATH_FILE_name" id="fournisseurs_file_PATH_FILE_name" type="hidden" value="<?= set_value('fournisseurs_file_PATH_FILE_name', $fournisseurs_file->PATH_FILE); ?>">
                               </div>
                        </div>                        
          </div>
            <div class="message"></div>
          <div class="modal-footer">
            <button type="button"  class="btn btn-secondary" id="close">Fermer</button>
            <a class="btn btn-flat btn-primary btn_save" id="btn_save" data-stype='back' title="Enregistrer">
            <i class="fa fa-save"></i> Enregistrer </a>
            <span class="loading loading-hide">
              <img src="<?= BASE_ASSET; ?>/img/loading-spin-primary.svg"> 
              <i><?= cclang('loading_saving_data'); ?></i>
            </span>  
          </div>
        </div>
        <?= form_close(); ?>
      </div>
    </div>
    <!-- Modal -->
                                 <?php endforeach; ?>
                                
                             </tbody>
                          </table>
                          </div>
                                             
                        </div>

                        <div class="tab-pane" id="approvisionnement">
                          <div class="table-responsive"> 
                          <table class="table table-bordered table-striped dataTable">
                             <thead>
                                <tr class="">
                                   <th>Type Fournisseur</th>
                                   <th>Fournisseur</th>
                                   <th>Date</th>
                                    <th>Auteur</th>
                                   <th>Action</th>
                                </tr>
                             </thead>
                            <tbody id="tbody_fournisseurs">
                               <?php foreach($approvisionnement as $approvisionnement): 
                                $auth_user = $this->model_registers->getOne('aauth_users',array('id'=>$approvisionnement->AUTHOR_APPROVISIONNEMENT));
                                ?>
                                <tr>
                                  
                                  <td><?= _ent($approvisionnement->DESIGN_TYPE_APPROVISIONNEMENT);?></td>
                                  <td><?= _ent($approvisionnement->NOM);?></td> 
                                  <td><?= _ent($approvisionnement->DATE_CREATION_APPROVISIONNEMENT); ?></td>   
                                  <td><?= $auth_user['username']; ?></td> 
                                  
                                   <td width="200">
                                     <a href="<?= site_url('administrator/approvisionnement/prints/'.$this->uri->segment(4).'/'.$approvisionnement->ID_APPROVISIONNEMENT); ?>" class="btn btn-primary btn-sm" title="" data-original-title="Imprimer" href=""><i class="fa fa-print "></i></a>
                                    </td>
                                  </tr>

                                 <?php endforeach; ?>
                                
                             </tbody>
                          </table>
                          </div>
                                             
                        </div>


                    </div>

                  </div>

               </div>
            </div>
            <!--/box body -->
         </div>
         <!--/box -->

      </div>
   </div>
</section>
<!-- /.content -->
<script>
  function appel_modal(data){
        $('#REF_ID_FILE').val(data);
        $("#myModal").modal();
      }
  $(document).ready(function(){

    $('.btn_save').click(function(){
        $('.message').fadeOut();
                    
        var form_fournisseurs_file = $('#form_fournisseurs_file'); 
        var data_post = form_fournisseurs_file.serializeArray();
        var save_type = $(this).attr('data-stype');

        data_post.push({name: 'save_type', value: save_type});
    
        $('.loading').show();
    
        $.ajax({
          url: BASE_URL + '/administrator/fournisseurs/edit_file/<?=$this->uri->segment(4);?>/<?=$this->uri->segment(5);?>',
          type: 'POST',
          dataType: 'json',
          data: data_post,
        })
        .done(function(res) {
          if(res.success) {
            var id_PATH_FILE = $('#fournisseurs_file_PATH_FILE_galery').find('li').attr('qq-file-id');
            
            if (save_type == 'back') {
              window.location.href = res.redirect;
              return;
            }
    
            $('.message').printMessage({message : res.message});
            $('.message').fadeIn();
            resetForm();
            if (typeof id_PATH_FILE !== 'undefined') {
                    $('#fournisseurs_file_PATH_FILE_galery').fineUploader('deleteFile', id_PATH_FILE);
                }
            $('.chosen option').prop('selected', false).trigger('chosen:updated');
                
          } else {
            $('.message').printMessage({message : res.message, type : 'warning'});
          }
    
        })
     
        .fail(function() {
          $('.message').printMessage({message : 'Error save data', type : 'warning'});
        })
        .always(function() {
          $('.loading').hide();
          $('html, body').animate({ scrollTop: $(document).height() }, 2000);
        });
    
        return false;
      }); /*end btn save*/

      var params = {};
         params[csrf] = token;
         const REF_ID_FILE = $('#REF_ID_FILE').val();
         $('#fournisseurs_file_PATH_FILE_galery').fineUploader({
            template: 'qq-template-gallery',
            request: {
                endpoint: BASE_URL + '/administrator/fournisseurs/upload_PATH_FILE_file',
                params : params
            },
            deleteFile: {
                enabled: true, 
                endpoint: BASE_URL + '/administrator/fournisseurs/delete_PATH_FILE_file',
            },
            thumbnails: {
                placeholders: {
                    waitingPath: BASE_URL + '/asset/fine-upload/placeholders/waiting-generic.png',
                    notAvailablePath: BASE_URL + '/asset/fine-upload/placeholders/not_available-generic.png'
                }
            },
             session : {
             endpoint: BASE_URL + 'administrator/fournisseurs/get_PATH_FILE_file/'+REF_ID_FILE,
             refreshOnRequest:true
           },
            multiple : false,
            validation: {
                allowedExtensions: ["*"],
                sizeLimit : 0,
                          },
            showMessage: function(msg) {
                toastr['error'](msg);
            },
            callbacks: {
                onComplete : function(id, name, xhr) {
                  if (xhr.success) {
                     var uuid = $('#fournisseurs_file_PATH_FILE_galery').fineUploader('getUuid', id);
                     $('#fournisseurs_file_PATH_FILE_uuid').val(uuid);
                     $('#fournisseurs_file_PATH_FILE_name').val(xhr.uploadName);
                  } else {
                     toastr['error'](xhr.error);
                  }
                },
                onSubmit : function(id, name) {
                    var uuid = $('#fournisseurs_file_PATH_FILE_uuid').val();
                    $.get(BASE_URL + '/administrator/fournisseurs/delete_PATH_FILE_file/' + uuid);
                },
                onDeleteComplete : function(id, xhr, isError) {
                  if (isError == false) {
                    $('#fournisseurs_file_PATH_FILE_uuid').val('');
                    $('#fournisseurs_file_PATH_FILE_name').val('');
                  }
                }
            }
        }); /*end PATH_FILE galery*/

   
    $('.remove-data').click(function(){

      var url = $(this).attr('data-href');

      swal({
          title: "<?= cclang('are_you_sure'); ?>",
          text: "<?= cclang('data_to_be_deleted_can_not_be_restored'); ?>",
          type: "warning",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "<?= cclang('yes_delete_it'); ?>",
          cancelButtonText: "<?= cclang('no_cancel_plx'); ?>",
          closeOnConfirm: true,
          closeOnCancel: true
        },
        function(isConfirm){
          if (isConfirm) {
            document.location.href = url;            
          }
        });

      return false;
    });

  }); /*end doc ready*/
</script>
