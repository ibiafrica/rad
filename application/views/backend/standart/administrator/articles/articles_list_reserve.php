
<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>

<script type="text/javascript">
//This page is a result of an autogenerated content made by running test.html with firefox.
function domo(){
 
   // Binding keys
   $('*').bind('keydown', 'Ctrl+a', function assets() {
       window.location.href = BASE_URL + '/administrator/articles/add/<?=$this->uri->segment(4);?>';
       return false;
   });

   $('*').bind('keydown', 'Ctrl+f', function assets() {
       $('#sbtn').trigger('click');
       return false;
   });

   $('*').bind('keydown', 'Ctrl+x', function assets() {
       $('#reset').trigger('click');
       return false;
   });

   $('*').bind('keydown', 'Ctrl+b', function assets() {

       $('#reset').trigger('click');
       return false;
   });
}

jQuery(document).ready(domo);
</script>
<!-- Content Header (Page header) -->
<section class="content-header">
   <h1>
      Liste des articles reserves
   </h1>
   <h5 class="widget-user-desc"><i class="label bg-yellow"><?= $articles_counts; ?>  <?= cclang('items'); ?></i></h5>
   <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
      <li class="active">Produits</li>
   </ol>
</section>
<!-- Main content -->
<section class="content">
   <div class="row" >
      
      <div class="col-md-12">
         <div class="box box-warning">
            <div class="box-body ">
               <!-- Widget: user widget style 1 -->
               <div class="box box-widget widget-user-2">
                  <!-- Add the bg color to the header using any of the bg-* classes -->
                <form name="form_articles" id="form_articles" action="<?= base_url('administrator/articles/article_reserve/'.$this->uri->segment(4).''); ?>">
                  <div class="widget-user-header ">
                     <div class="row pull-center" style="margin-left:5%">
                        <div class="col-md-8">

                         <div class="col-sm-4 padd-left-0  " >
                            <input type="text" class="form-control" name="q" id="filter" placeholder="<?= cclang('filter'); ?>" value="<?= $this->input->get('q'); ?>">
                         </div>
                         <div class="col-sm-3 padd-left-0 " >
                            <select type="text" class="form-control chosen chosen-select" name="f" id="field" >
                                <option <?= $this->input->get('f') == 'NUMERO_REQUISITION' ? 'selected' :''; ?> value="NUMERO_REQUISITION">Numero</option>
                                <option <?= $this->input->get('f') == 'REF_COMMAND_REQUISITION' ? 'selected' :''; ?> value="REF_COMMAND_REQUISITION">Commande</option>
                                <option <?= $this->input->get('f') == 'REF_CODEBAR' ? 'selected' :''; ?> value="REF_CODEBAR">Codebarre</option>
                              </select>
                         </div>
                         <div class="col-sm-1 padd-left-0 ">
                            <button type="submit" class="btn btn-flat" name="sbtn" id="sbtn" value="Apply" title="<?= cclang('filter_search'); ?>">
                            Filter
                            </button>
                         </div>
                         <div class="col-sm-3 padd-left-0">
                             <?php is_allowed('articles_export', function(){?>
                              <a class="btn btn-default" title="Export XLS" onclick="exportToExcel('exceltable')"><i class="fa fa-file-excel-o" > Export</i> </a>
                              <?php }) ?>
                         </div>
                         <div class="col-sm-1 padd-left-0 ">
                            <a class="btn btn-default btn-flat" name="reset" id="reset" value="Apply" href="<?= base_url('administrator/articles/article_reserve/'.$this->uri->segment(4).'');?>" title="<?= cclang('reset_filter'); ?>">
                            <i class="fa fa-undo"></i>
                            </a>
                         </div>
                      </div>
                        
                     </div>
                  </div>
              </form>

                  <div class="table-responsive"> 
                  <table class="table table-bordered table-striped dataTable" id="exceltable">
                     <thead>
                        <tr class="">
                           <th width="50">N°</th>
                           <th width="200">Numero Requisition/Fiche</th>
                           <th>Numero Commande</th>
                           <th>Codebarre</th>
                           <th width="600">Nom du produit</th>
                           <th>Reservées</th>
                        </tr>
                     </thead>
                     <tbody id="tbody_articles_reserve">
                     <?php 
                     $ii = 0;
                     if(!empty($this->uri->segment(5))){
                      $ii = $offset;
                     }
                     $i = $ii;
                     $total = 0;
                     foreach($articless as $articles): 
                      $i++;
                      if ($articles->Q == '') {
                          $qt = 0;
                      } else {
                          $qt = $articles->Q;
                      }
                      $qtrest = $articles->QUANTITE - $qt;
                      $total += round($qtrest, 2);
                      ?>
                        <tr>
                           <td width="5"><?=$i?></td>
                           <td><?= $articles->NUMERO_REQUISITION; ?></td>
                           <td><?= $articles->REF_COMMAND_REQUISITION; ?></td>
                           <td><?= $articles->REF_CODEBAR; ?></td> 
                           <td><?= $articles->NAME; ?></td>
                           <td><?= round($qtrest, 2); ?></td>
                        </tr>
                      <?php endforeach; ?>
                        <tr>
                           <td colspan="5"><strong>Total</strong></td>
                           <td><?= $total ?></td>
                        </tr>
                      <?php if ($articles_counts == 0) :?>
                         <tr>
                           <td colspan="100">
                           Les données sur les produits ne sont pas disponibles
                           </td>
                         </tr>
                      <?php endif; ?>
                     </tbody>
                  </table>
                  </div>
               </div>
               <hr>
               <!-- /.widget-user -->
               <div class="row">
                  <div class="col-md-8">
                  </div>                
                  <div class="col-md-4">
                     <div class="dataTables_paginate paging_simple_numbers pull-right" id="example2_paginate" >
                        <?= $pagination; ?>
                     </div>
                  </div>
               </div>
            </div>
            <!--/box body -->
         </div>
         <!--/box -->
      </div>
   </div>
</section>
<!-- /.content -->
<script type="text/javascript">
   //export in excel
function exportToExcel(tableId) {
    let uri = 'data:application/vnd.ms-excel;base64,', 
  template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="https://www.w3.org/TR/html401/"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>',
  base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) },
  format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; })}

  let table = document.getElementById(tableId)
  if (!table) {
    return;
  }
  let ctx = {worksheet: tableId || 'Worksheet', table: table.innerHTML}
  var str = base64(format(template, ctx));
  var blob = b64toBlob(str, "application/vnd.ms-excel");
  var blobUrl = URL.createObjectURL(blob);

  let link = document.createElement('a');
  var openedTabId = 'Listes_articles_reservees';
  link.download = openedTabId + '.xls'; // the fileName for download
  link.href = blobUrl;
  link.click();
  // window.location = blobUrl; // instead of using a link, could also do this;

  function b64toBlob(b64Data, contentType='', sliceSize=512) {
      var byteCharacters = atob(b64Data);
      var byteArrays = [];

      for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
          var slice = byteCharacters.slice(offset, offset + sliceSize);

          var byteNumbers = new Array(slice.length);
          for (var i = 0; i < slice.length; i++) {
              byteNumbers[i] = slice.charCodeAt(i);
          }

          var byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
      }

      var blob = new Blob(byteArrays, {type: contentType});
      return blob;
  }
}
</script>