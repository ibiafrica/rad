<style>
  * {
    box-sizing: border-box;
  }

  #myInput {
    /*background-image: url('<?= BASE_ASSET; ?>/img/icon/s.png');
  background-position: 10px 12px;
  background-repeat: no-repeat;*/
    width: 100%;
    font-size: 15px;
    padding: 12px 20px 12px 40px;
    border: 1px solid #ddd;
    /* margin-bottom: 12px; */
  }

  .inp {

    font-size: 15px !important;
    padding: 12px 20px 12px 40px !important;
    border: 1px solid #ddd;
  }

  #myUL {
    list-style-type: none;
    padding: 0;
    margin: 0;
  }

  #myUL li a {
    border: 1px solid #ddd;
    margin-top: -1px;
    /* Prevent double borders */
    background-color: #f6f6f6;
    padding: 5px;
    text-decoration: none;
    font-size:15px;
    color: black;
    display: block
  }

  #myUL li a:hover:not(.header) {
    background-color: #f7f7f7;
  }

  textarea:focus, input:focus{
    outline: none !important;
}
</style>
<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>
<script type="text/javascript">
//This page is a result of an autogenerated content made by running test.html with firefox.
function domo(){
 
   // Binding keys
   $('*').bind('keydown', 'Ctrl+e', function assets() {
      $('#btn_edit').trigger('click');
       return false;
   });

   $('*').bind('keydown', 'Ctrl+x', function assets() {
      $('#btn_back').trigger('click');
       return false;
   });
    
}


jQuery(document).ready(domo);
</script>
<!-- Content Header (Page header) -->
<section class="content-header">
   <h1>
      Pos Menu Du Jours      <small><?= cclang('detail', ['Pos Menu Du Jours']); ?> </small>
   </h1>
   <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
      <li class=""><a  href="<?= site_url('administrator/pos_ibi_menu_du_jous'); ?>">Pos Menu Du Jours</a></li>
      <li class="active"><?= cclang('detail'); ?></li>
   </ol>
</section>
<!-- Main content -->
<section class="content">
   <div class="row" >
     
      <div class="col-md-12">
         <div class="box box-warning">
            <div class="box-body ">

               <!-- Widget: user widget style 1 -->
               <div class="box box-widget widget-user-2">
                  <!-- Add the bg color to the header using any of the bg-* classes -->
                 <ul class="list-group">
                   <li class="list-group-item active">
                   <div class="row">
                        <div class="col-md-12">
                     <div class="col-md-6">
                     Menu : <?= _ent($pos_ibi_menu_du_jous->DESIGNATION_MENU); ?>
                      <textarea id="editable" style="display:none"  value="<?= _ent($pos_ibi_menu_du_jous->DESIGNATION_MENU); ?>"></textarea>
                     
                     </div>
                       <div class="col-md-6">
                         <div class="btn-group pull-right" role="group" style="padding:0px;margin:0px">
                        <button  class="btn btn-default btn-flat btn-sm" id="Para1">
                        <i class="fa fa-pencil"></i>
                        </button>
                        <button class="btn btn-default btn-sm" data-toggle="modal" data-target="#exampleModal">
                        <i class="fa fa-plus"></i>
                        </button>
                        </div>
                     </div>

                   </div>
                   </div>
                     </li>
                   <?php $id_menu = $pos_ibi_menu_du_jous->ID_MENU;
                         $requete = $this->db->get_where('pos_ibi_menu_du_jous_details',array('MENU_ID'=>$id_menu));
                            foreach ($requete->result() as $k) { ?>
                            <li class="list-group-item">
                            <div class="row">
                              <div class="col-md-12">
                            <div class="col-md-3">
                             <?php echo $k->MOM_ARTICLE_MENU_DETAIL;?>
                            </div>
                              <div class="col-md-3">
                             <?php echo $k->CODE_BAR_ARTICLE;?>
                            </div>
                            <div class="col-md-3">
                             <?php echo $k->QUANTITE_ARTICLE_MENU_DETAIL;?>
                            </div>
                               <div class="col-md-3">
                               <i class="fa fa-close fa-2x btn_delete" style="color:red" data-id="<?php  echo $k->ARTICLE_ID; ?>" menu-id="<?php  echo $id_menu; ?>"></i>
                            </div>
                            </div>
                            </div>
                            </li>
                            <?php
                            }
                          ?>
                 </ul>


                 <!-- Modal -->
                        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                           <div class="modal-content">
                              <div class="modal-header">
                              <!-- <h5 class="modal-title" id="exampleModalLabel">Modal title</h5> -->
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                 <span aria-hidden="true">&times;</span>
                              </button>
                              </div>
                              <div class="modal-body">
                                    <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Rechercher l'article par son nom ou son code bar">

                                    <ul id="myUL" hidden style="height:180px; overflow-y:scroll;">
                                       <li> default</li>

                                    </ul>

                                    <div class="table-responsive" style="margin-top: 10px">
                                 <form name="form_pos_ibi_menu_du_jous" id="form_pos_ibi_menu_du_jous">
                                 
                                       <input type="hidden" name="uri" value="<?php echo $this->uri->segment(2);  ?>">
                                       <table id="mytable" class="table table-bordered table-striped ">
                                       <tr>
                                          <th width="310px">Code</th>
                                          <th width="320px">Designation</th>
                                          <th width="300px">Quantité</th>
                                          <th width="300px">Action</th>

                                       </tr>

                                       </table>
                                    </div>
                                    </form>
                              </div>
                              <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                              <p class="btn btn-flat btn-info btn_save btn_action btn_save_back" id="btn_save" data-stype='back' title="<?= cclang('save_and_go_the_list_button'); ?> (Ctrl+d)">
                              <i class="ion ion-ios-list-outline"></i> Enregistrer
                               </p>   
                               </div>
                           </div>
                        </div>
                        </div>
            

                    
                  </div>
               </div>
            </div>
            <!--/box body -->
         </div>
         <!--/box -->

      </div>
   </div>
</section>
<!-- /.content -->


<script>
  var store = "<?= $this->uri->segment(2) ?>";

  function getData(val) {
    let type = $('input[name=typeReq]:checked', '#form_pos_ibi_requisition').val();
    $.ajax({
        url: BASE_URL + 'administrator/requisition/getType',
        // dataType:'JSON',
        method: 'POST',
        data: {
          store: store,
          type: type
        },
      })
      .done(function(data) {
        console.log(data)
        $('.typeData').html(data);
      })
  }

  function myFunction() {
    //  ad =document.getElementById("myUL").style.display = 'block';
    let btq = $('#BOUTIQUE').val();




    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById("myInput");
    filter = input.value.toUpperCase();
    ul = document.getElementById("myUL");

    ul.style.display = 'block';
    li = ul.getElementsByTagName("li");
    console.log(filter);
    filter === '' ? $('#myUL').attr('hidden', 'true') : $('#myUL').removeAttr('hidden');
    for (i = 0; i < li.length; i++) {
      a = li[i].getElementsByTagName("a")[0];
      txtValue = a.textContent || a.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "";
      } else {
        li[i].style.display = "none";
      }
    }
  }
  var myarray = [];

  $(document).on('click', '.del', function() {
    let id = $(this).closest('tr').find('.idA').val();
    myarray = myarray.filter((data) => {
      return data != id;
    });

    $(this).closest('tr').remove();

  });


  $(document).on('click', '.singleItem', function() {

    let id = $(this).attr('id');
    let name = $('#BOUTIQUE').attr('name');
    if (name == 'BOUTIQUE') {
      if ($(this).attr('qt') == 0) {
        // swal("Rappel!", "Cet article est épuisé en stock", "warning");
        $('#myUL').attr('hidden', 'true');
        // $('#myInput').val('');
        // return;
      }
    }

    $('#myUL').hide();


    if (myarray.includes(id)) {
      swal('Desolé!', 'Cet ingredient existe deja dans le tableau', 'warning');
      $('#myUL').attr('hidden', 'true');
      $('#myInput').val('');
      return;
    }
    myarray.push(id);
    $('#myUL').attr('hidden', 'true');
    $('#myInput').val('');
    let html = '';



    html = `<tr >
           
           <form id="form_pos_ibi_requisition" method="post"> 

             <td> <input type="hidden" name="CODE_BAR[]" class="code" value="${$(this).attr('code')}"> ${$(this).attr('code')} </td>

            <input type="hidden" name="ARTICLE_ID_MENU[]" class="code" value="${$(this).attr('ID')}">

            <td><input type="hidden" name="NOM_INGREDIENT[]" value="${$(this).attr('name')}"> ${$(this).attr('name')}</td>
  
             <td> <input type="text" name="QUANTITY_INGREDIENT[]" class="form-control" qt" value=""></td>           
            <td width="50px">
              <input type="hidden" value="${$(this).attr('id')}" class="idA">
              <button class="btn btn-sm btn-warning del"><i class="fa fa-close"></i></button>
          </td>
       </tr>`;



    $('#mytable tbody tr:first').after(html);


  })



  $(document).on('input', '#inputQ', function() {
    let name = $('#BOUTIQUE').attr('name');
    let qt = $(this).closest('tr').find('.qt').val();
    let val = $(this).val();
    if (val == '' || parseFloat(val) < 1) {
      val = 1;
      $(this).val(1)
    }

    if (name == 'BOUTIQUE') {

      if (parseInt(val) > parseInt(qt)) {
        swal('Desolé!', 'dans cette boutique il y a seulement (' + qt + ') quantité pour ce produit', 'warning');
        if (qt.length > 1) {
          $(this).val(val.slice(0, -1));
        } else {
          $(this).val(1)
        }

        return;
      }

    }

    let prixunit = $(this).closest('tr').find('.prix').val();
    let total = val * parseFloat(prixunit);
    $(this).closest('tr').find('.prixtotal').val(total);
    $(this).closest('tr').find('.text').text(total);

  })


  $(document).on('click', '.plus', function() {
    let qt = $(this).closest('tr').find('.qt').val();
    let val = $(this).parent().find('input').val();
    let name = $('#BOUTIQUE').attr('name');

    if (name == 'BOUTIQUE') {
      if (parseInt(val) >= parseInt(qt)) {
        swal('Desolé!', 'dans cette boutique il y a seulement (' + qt + ') quantité pour ce produit', 'warning');
        return;
      }
    }

    let qrest = parseInt(val) + 1;
    $(this).parent().find('input').val(qrest);
    let prixunit = $(this).closest('tr').find('.prix').val();
    let total = qrest * parseFloat(prixunit);
    $(this).closest('tr').find('.prixtotal').val(total);
    $(this).closest('tr').find('.text').text(total);

  })

  $(document).on('click', '.minus', function() {
    let val = $(this).parent().find('input').val();
    let qrest = parseInt(val) - 1;
    if (qrest < 1) {
      qrest = 1
    }
    $(this).parent().find('input').val(qrest);
    let prixunit = $(this).closest('tr').find('.prix').val();
    let total = qrest * parseFloat(prixunit);
    $(this).closest('tr').find('.prixtotal').val(total);
    $(this).closest('tr').find('.text').text(total);
  })

  $(document).on('click', '.del', function() {
    $(this).closest('tr').remove();

  })




  function fetchdata() {

    const id = <?php echo $this->uri->segment(2); ?>;
    $('.loading').show();
    $('#myUL').attr('hidden', 'true');
    $('#myInput').val('');
    $.ajax({
        url: BASE_URL + 'administrator/pos_ibi_menu_du_jous/get_plat/<?php echo $this->uri->segment(2) ?>',
        type: 'post',
        dataType: 'json',
        data: {
          id: id,
          name: name,
          "<?php echo $this->security->get_csrf_token_name(); ?>": "<?php echo $this->security->get_csrf_hash(); ?>"
        },
        async: true,
      })
      .done(function(data) {
        console.log(data)
        $('#myUL').html('')
        $('.message').fadeOut();
        for (var i = data.length - 1; i >= 0; i--) {

          $('#myUL').append(`<li qt="${data[i].QTE} " unt="${data[i].UNITE}" 
         id="${data[i].ID}" prix="${data[i].PRIX}" prixTotal="${data[i].PRIX_DACHAT_INGREDIENT}"
         name="${data[i].NOM_ART}" code="${data[i].CODEBAR}" 
         class="singleItem"><a>${data[i].NOM_ART} ${data[i].CODEBAR} </a></li>`);
        }
      })
      .always(function() {
        $('.loading').hide();
        $('html, body').animate({
          scrollTop: $(document).height()
        }, 2000);

      })
      .fail(function() {
        $('.message').printMessage({
          message: 'La recuperation des ingredients a echoué',
          type: 'warning'
        });
      });
  }
  fetchdata();


   $('.btn_save').click(function() {
      $('.message').fadeOut();

      var form_pos_ibi_requisition = $('#form_pos_ibi_menu_du_jous');
      var data_post = form_pos_ibi_requisition.serializeArray();
      var save_type = $(this).attr('data-stype');

      data_post.push({
        name: 'save_type',
        value: save_type
      });

      $('.loading').show();

      $.ajax({
          url: BASE_URL + 'administrator/pos_ibi_menu_du_jous/update_plats_menu/<?= $this->uri->segment(4) ?>',
          type: 'POST',
          dataType: 'json',
          data: data_post,
        })
        .done(function(res) {
          if (res.success) {
             console.log(res)

            if (save_type == 'back') {
              window.location.href = res.redirect;
              return;
            }

            $('.message').printMessage({
              message: res.message
            });
            $('.message').fadeIn();
            resetForm();
            $('.chosen option').prop('selected', false).trigger('chosen:updated');

          } else {
            $('.message').printMessage({
              message: res.message,
              type: 'warning'
            });
          }

        })
        .fail(function() {
          $('.message').printMessage({
            message: 'Error save data',
            type: 'warning'
          });
        })
        .always(function() {
          $('.loading').hide();
          $('html, body').animate({
            scrollTop: $(document).height()
          }, 2000);
        });

      return false;
    }); /*end btn save*/

    $(".btn_delete").on('click',function () {
        var id = $(this).attr('data-id');
        var menu_id = $(this).attr('menu-id');
        var store = <?php echo $this->uri->segment(2); ?>;
        
        var type = 'back';
            swal({
            title: "",
            text: "Voulez vous vraiment retirer ce plat !",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            cancelButtonText: "Fermer",
            closeOnConfirm: true,
            closeOnCancel: true,
            animation: "slide-from-top",
             },
             function(isConfirm){
                if (isConfirm) {
                       $.ajax({
                        url: BASE_URL + '/administrator/pos_ibi_menu_du_jous/delete_menu_plat',
                        type: 'POST',
                        dataType: 'json',
                        data:{id_menu:menu_id,save_type:type,store:store,article:id},
                      })
                      .done(function(res) {
                        if(res.success) {
                        //   if (save_type == 'back') {
                            window.location.href = res.redirect;
                        //     return;
                        //   }
                  
                          $('.message').printMessage({message : res.message});
                          $('.message').fadeIn();
                          $('.data_file_uuid').val('');
                  
                        } else {
                          $('.message').printMessage({message : res.message, type : 'warning'});
                        }
                  
                      })
                      .fail(function() {
                        $('.message').printMessage({message : 'Error save data', type : 'warning'});
                      })
                      .always(function() {
                        $('.loading').hide();
                        $('html, body').animate({ scrollTop: $(document).height() }, 2000);
                      });
                }
              }
             
             
             );

    });

    $("#Para1").click(function () {
    $('#editable').html($(this).html()).show().focus();
    $(this).hide();
});

$("#editable").blur(function () {
    $('#Para1').html($(this).val()).show();
    $('#editable').hide();
});
</script>

