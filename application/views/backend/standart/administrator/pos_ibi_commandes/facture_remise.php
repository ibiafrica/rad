<script>
  $(function() {
    $('.chosen-select').chosen();
    $('.chosen-select-deselect').chosen({
      allow_single_deselect: true
    });
  });
</script>

<style>
  .list-group-item:hover {
    background-color: #cccccc4a !important;
    cursor: pointer;
  }
</style>

<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>

<script type="text/javascript">
  //This page is a result of an autogenerated content made by running test.html with firefox.
  function domo() {

    // Binding keys
    $('*').bind('keydown', 'Ctrl+a', function assets() {
      window.location.href = BASE_URL + '/administrator/pos_ibi_commandes/add';
      return false;
    });

    $('*').bind('keydown', 'Ctrl+f', function assets() {
      $('#sbtn').trigger('click');
      return false;
    });

    $('*').bind('keydown', 'Ctrl+x', function assets() {
      $('#reset').trigger('click');
      return false;
    });

    $('*').bind('keydown', 'Ctrl+b', function assets() {

      $('#reset').trigger('click');
      return false;
    });
  }



  jQuery(document).ready(domo);
</script>
<!-- Content Header (Page header) -->
<section class="content-header">
  <h1>
    Pos Ibi Commandes </h1>
  <ol class="breadcrumb">
    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
    <li class="active">Pos Ibi Commandes</li>
  </ol>
</section>
<!-- Main content -->
<section class="content">
  <div class="row">

    <div class="col-md-12">
      <div class="box box-warning">
        <div class="box-body ">
          <!-- Widget: user widget style 1 -->


          <form name="form_pos_ibi_commandes" id="form_pos_ibi_commandes" action="<?= base_url('administrator/pos_ibi_commandes/index'); ?>">

            <!-- /.widget-user -->
            <div class="row">

              <div class="col-sm-7 col-md-1" style=""></div>
              <div class="col-sm-12 col-md-11" style="float: right;">

                <div class="col-sm-4 padd-left-0">
                </div>

                <div class="col-sm-2 padd-left-0">
                  <!-- <select class="form-control" name="shift"  data-toggle="modal" data-target="#GSCCModal" data-keyboard="false" data-backdrop="static"> -->
               
                </div>


                <div class="col-sm-2 padd-left-0">
                  <select class="form-control type_remise" name="status" id="type_remise">
                    <option value="">Remise</option>
                    <option value="0">Remise en espece </option>
                    <option value="1">
                      En pourcentage
                    </option>
                  </select>
                </div>

              </div>
            </div>

          </form>

          <br>

          <div id="confirmedit" style="display: none" class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h3 class="modal-title" id="exampleModalLabel"> Choissez le type de modification</h3>
                </div>
                <div class="modal-body" style="display: flex;justify-content: space-around">
                  <button type="button" class="btn btn-info confirmEdit" data-type="1">
                    Ajouter à la commande
                  </button>
                  <button type="button" class="btn btn-success confirmEdit" data-type="2">Retirer à la commande</button>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary cancelEdit">Close</button>

                </div>
              </div>
            </div>
          </div>
          <div class="col-md-12">


        
                    <form id="form_remise" method="POST" action="<?php  echo base_url('administrator/pos_ibi_commandes/facture_remise_add/'.$this->uri->segment(4)) ?>">
                    <ul class="list-group">
                      <li class="list-group-item bg-danger">
                          <div class="row">
                                 <div class="col-md-4">
                                 <strong>Designation</strong>
                                  </div>
                            <div class="col-md-1">
                             <strong>Quantite</strong>
                            </div>

                             <div class="col-md-1">
                              <strong>Prix</strong>  
                               </div>

                            <div class="col-md-1">
                             <strong>Total</strong> 
                            </div>

                               <div class="col-md-1">
                                <strong>Remise</strong> 
                                 </div>
                        </li>
                       <?php foreach ($produits as $k) {
                           ?>
                           <li class="list-group-item" id="list_item_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>">
                           <div class="row">
                                 <div class="col-md-4">
                               <?php 
                                 $product=$k->REF_PRODUCT_CODEBAR;
                                 $store = $k->STORE_ID_pos_IBI_COMMANDES_PRODUITS;
                                 $name = $this->db->get_where('pos_store_'.$store.'_ibi_articles',array('CODEBAR_ARTICLE'=>$product))->result();
                                 foreach ($name as $a) {
                                     echo $a->DESIGN_ARTICLE;
                                 }
                             ?>
                            </div>
                            <div class="col-md-1">
                               <?php echo $k->QUANTITE;  ?>
                               <input type="hidden" name="quantite[]" class="quantite_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>" value="<?php echo  $k->QUANTITE; ?>">
                            </div>

                             <div class="col-md-1">
                                <span class="prix_ti_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>"> <?php echo $k->PRIX;  ?></span>
                                <input type="hidden" name="prix[]" class="prix_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>" value="<?php echo  $k->PRIX; ?>">
                            </div>

                            <div class="col-md-1">
                                <span class="prix_tot_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>"><?php echo $k->PRIX_TOTAL;  ?></span>
                                <input type="hidden" name="prix_total[]" class="prix_total prix_total_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>" value="<?php echo  $k->PRIX_TOTAL; ?>">
                            </div>

                               <div class="col-md-1">
                                 <input style="border-color:#c4c4c4 !important;border:1px solid #c4c4c4;" name="discount[]" class="it item_<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>" type="number" min="0" value="0" onchange="remise(<?php  echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>)" onkeyup="remise(<?php  echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>)">
                                 <input type="hidden" name="produit_id[]" value="<?php echo $k->ID_pos_IBI_COMMANDES_PRODUITS; ?>">
                                 </div>

                           </div>
                       
                         
                           </li>
                      <?php } ?>
                    </ul>
        


            
          <div class="row col-md-12">
              <div class="pull-right lead"><h3>Le montant total :<span id="total_all"></span>Fbu</h3></div>
              <input type="hidden" class="form-control total_all_val" min="0" name="total_all_val"  value="0" placeholder="Remise global">
            </div>
             <div class="row col-md-12">
              <div class="pull-right lead">
              <!-- <span style="display:inline"><h3>Remise global:</span>  -->
              <span style="display:inline">
              <input type="number" class="form-control" id="remise_globale" name="remise_globale" min="0" value="0" placeholder="Remise global" onchange="remise_global()"></span>
              </h3>
              </div>
            </div>
            </form>

                   <div class="row col-md-12">
              <div class="pull-right lead">
                   <button class="bt nbtn-default col-md-12 btn-valider" data-stype='back'>Valider </button>
              </div>
            </div>

          </div>

        </div>
        <!--/box body -->
      </div>
      <!--/box -->
    </div>
  </div>
</section>



<script>
$('.btn-valider').on('click',function () {
           
            const form_marge_remise = $("#form_remise");
            const data_post = $("#form_remise").serialize();
            const type_remise = $("#type_remise").val();
            var save_type = $(this).attr('data-stype');
             // data_post.push({name: 'save_type', value: save_type});
                  
             swal({
                 title: "Attention",
                 text: "La remise de cette facture va affecter le prix  !",
                 showCancelButton: true,
                 confirmButtonColor: "#DD6B55",
                 cancelButtonText: "Fermer",
                 closeOnConfirm: true,
                 closeOnCancel: true,
                 animation: "slide-from-top",
             },


             function(isConfirm){
                if (isConfirm) {
                       $.ajax({
                        url: form_marge_remise.attr('action'),
                        type: 'POST',
                        dataType: 'json',
                        data: data_post+"&type_remise="+type_remise+"&save_type="+save_type,
                        success:function (params) {
                        if(params.success) {
                          if (save_type == 'back') {
                            window.location.href = params.redirect;
                            return;
                          }
                  
                          $('.message').printMessage({message : params.message});
                          $('.message').fadeIn();
                          // $('.data_file_uuid').val('');
                  
                        } else {
                          $('.message').printMessage({message : res.message, type : 'warning'});
                        }
                        }
                      })
                      .done(function(res) {
                     
                  
                      })
                      .fail(function() {
                        $('.message').printMessage({message : 'Error save data', type : 'warning'});
                      })
                      .always(function() {
                        $('.loading').hide();
                        $('html, body').animate({ scrollTop: $(document).height() }, 2000);
                      });
                }
              }
             
             
             );
})
</script>

<script>
  $('.prints').on('click', function() {
    const id = $(this).attr('data-attr');
    console.log(" Vous etes  " + id);
    var table = document.getElementById('targets_' + id);
    // console.log(table);
    var ctx = table.outerHTML;
    var idname = name;
    var frame1 = document.createElement('iframe');
    frame1.name = "frame1";
    frame1.style.position = "absolute";
    frame1.style.top = "-1000000px";
    document.body.appendChild(frame1);
    var frameDoc = frame1.contentWindow ? frame1.contentWindow : frame1.contentDocument.document ? frame1
      .contentDocument.document : frame1.contentDocument;
    frameDoc.document.open();
    frameDoc.document.write('<html><head><title></title>');
    frameDoc.document.write(
      '<style>body{margin:10px !important}table {  border-collapse: collapse;  border-spacing: 0; width:100%; margin-top:20px;} .table td, .table > tbody > tr > td, .table > tbody > tr > th, .table > tfoot > tr > td, .table > tfoot > tr > th, .table > thead > tr > td, .table > thead > tr > th{ padding:8px 18px;border:1px  } .table-bordered, .table-bordered > tbody > tr > td, .table-bordered > tbody > tr > th, .table-bordered > tfoot > tr > td, .table-bordered > tfoot > tr > th, .table-bordered > thead > tr > td, .table-bordered > thead > tr > th {     border: 1px solid #000;}p + p { margin-left: 30px;}.body{width:100% !important}.no{display:none !important} </style>'
    ); // your title
    frameDoc.document.title = "Facture";
    frameDoc.document.write('<meta charset="utf-8"></head><body>');
    frameDoc.document.write(ctx);
    frameDoc.document.write('</body></html>');
    frameDoc.document.close();
    setTimeout(function() {
      window.frames["frame1"].focus();
      window.frames["frame1"].print();
      document.body.removeChild(frame1);
    }, 100);

  });
</script>


<script>
  var selectedcmd = undefined;
  $(document).ready(function() {


         var x = 0;
        $('.prix_total').each(function(){
            x += parseFloat($(this).val());  
        });
       $("#total_all").text(x)
      const remise =  $(".total_all_val").val(x);
       console.log("Les dernier:"+remise)
       

   // console.log("okayl....");
    $('.btnoptions').click(function(e) {
      selectedcmd = $(this).data('cmdid');
      $("#confirmedit").show();
    });

    $('.confirmEdit').on('click', function() {
      const num = $(this).data('type');
      window.location.href = "<?= site_url('administrator/pointdesventes/update_commande/'); ?>" + selectedcmd + '/' + num;
    });
    $('.cancelEdit').on('click', function() {
      $("#confirmedit").hide();
    });


    $('.remove-data').click(function() {

      var url = $(this).attr('data-href');

      swal({
          title: "<?= cclang('are_you_sure'); ?>",
          text: "<?= cclang('data_to_be_deleted_can_not_be_restored'); ?>",
          type: "input",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "<?= cclang('yes_delete_it'); ?>",
          cancelButtonText: "<?= cclang('no_cancel_plx'); ?>",
          closeOnConfirm: true,
          closeOnCancel: true,
          animation: "slide-from-top",
          inputPlaceholder: "Donnez un commentaire S.V.P."
        },
        function(inputValue) {
          if (inputValue === false) {
            return false;
          }
          if (inputValue === "") {
            swal.showInputError("Vous devriez ecrire un commentaire SVP.!!!");
            return false;
          }
          document.location.href = url + '?inputValue=' + inputValue;
        },
        function(isConfirm) {
          // if (isConfirm) {
          // document.location.href = BASE_URL + '/administrator/pos_ibi_commandes/delete?' + serialize_bulk;
          // }
        });

      return false;
    });
  }); /*end doc ready*/
</script>

<script>
  function remise(params) {
     // $(".prix_total_"+params).val(0);
      const quantite = $(".quantite_"+params).val();
      const prix = $(".prix_"+params).val();
      const prix_total = $(".prix_total_"+params).val();
      const nbr = $(".item_"+params).val();
      const type_remise = $("#type_remise").val();
      var value = $(".item_"+params).val();

      if (type_remise==1) {
            //$(".it").prop('max',100);
             if (value !== '') {
                  $(".item_"+params).val(Math.max(Math.min(value, 100), -100))
                }
            if (value>=0) {
            var n =parseFloat(prix)*(1-parseFloat(nbr)/100);
            $(".prix_total_"+params).val(n);
            $(".prix_ti_"+params).text(n);
            $(".prix_tot_"+params).text(n*quantite);
            $("#total_all").text("");
             }          
        

      } else {
          var type = 1;
         // remise_type(params,type,prix,nbr)
          // if (value !== '') {
          //         $(".item_"+params).val(Math.max(Math.min(value, 100), -100))
          //       }
         if (value>=0) {
             var n =parseFloat(prix) -parseFloat(nbr);
              $(".prix_total_"+params).val(n);
              $(".prix_ti_"+params).text(n);
              $(".prix_tot_"+params).text(n*quantite);
              $("#total_all").text("");
              console.log("Sommes :"+prix_total); 
            }
        

      }
      

      //sommees();

       var sum = 0;
        $('.prix_total').each(function(){
            isNaN(this.value) || 0 == this.value.length || (sum += parseFloat(this.value))
             console.log("Sommes :"+sum);
        });
       
        
        $("#total_all").text(sum)  
        $(".total_all_val").val(sum) 

  }

  function sommees() {
         //sommes total 
         var sum = 0;
        $('.prix_total').each(function(){
             isNaN(this.value) || 0 == this.value.length || (sum += parseFloat(this.value))
             //console.log("Sommes :"+sum);
        });
       
        
        $("#total_all").text(sum)  
        $(".total_all_val").val(sum) 

    //     const remisec =  $(".total_all_val").val();
    //    console.log("Les dernier:"+remisec)
  }

        function remise_global() {
            const type_remise = $("#type_remise").val();
            $("#total_all").text("") 
            const remise_global= $("#remise_globale").val();
            const total = $(".total_all_val").val();
                 if (type_remise==1) {
                        $("#remise_globale").prop('max',100);
                      if (remise_global>=0) {
                        var nbt_tot =parseFloat(total)*(1-parseFloat(remise_global)/100);
                          console.log("bingo"+nbt_tot)
                          $("#total_all").text(Math.round(nbt_tot))
                          $(".total_all_val").val(Math.round(nbt_tot)) 
                      }          
                  

                }else{
                     const nbt_tot = parseFloat(total)- parseFloat(remise_global);
                    console.log("bingo"+nbt_tot)
                    $("#total_all").text(Math.round(nbt_tot))
                    $(".total_all_val").val(Math.round(nbt_tot)) 
                }
          


        }



  function remise_type(item,type,price,nombre) {
        // $(".it").val(0);
          const quantite = $(".quantite_"+item).val();
          const prix = $(".prix_"+item).val();
          const nbr = $(".item_"+item).val();

          var n =parseFloat(price) -parseFloat(nombre);
         $(".prix_total_"+item).val(n);
          $(".prix_ti_"+item).text(n);
          $(".prix_tot_"+item).text(n*quantite);
          $("#total_all").text("");
        const data =prix*(1+nombre/100)
        $(".prix_total_"+item).val(data);
        console.log("Evenement reussi "+data)
  }
    



  
$(document).ready(function() {
    var searchedLoginClaims = sessionStorage.getItem("type_remise");
if(searchedLoginClaims != undefined || searchedLoginClaims != null){
      // console.log("jdjdjd"+searchedLoginClaims);

	$("select").find(":selected").removeAttr("selected");
  $("select").find("option").each(function () {
            if ($(this).val() == searchedLoginClaims) {
                $(this).attr("selected", true);
            }
        });
}
});  

$("#type_remise").on('change',function () {
   	sessionStorage.setItem("type_remise", $(".type_remise").first().val());
  location.reload();
});
</script>