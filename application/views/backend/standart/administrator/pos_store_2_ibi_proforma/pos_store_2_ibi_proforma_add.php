

<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>

<script type="text/javascript">

//This page is a result of an autogenerated content made by running test.html with firefox.

function domo(){

 

   // Binding keys

   $('*').bind('keydown', 'Ctrl+e', function assets() {

      $('#btn_edit').trigger('click');

       return false;

   });



   $('*').bind('keydown', 'Ctrl+x', function assets() {

      $('#btn_back').trigger('click');

       return false;

   });

    

}





jQuery(document).ready(domo);

</script>

<!-- Content Header (Page header) -->

<section class="content-header">

   <h1>

      Vérification du Proforma      <small><?//= cclang('detail', ['Proforma']); ?> </small>

   </h1>

   <ol class="breadcrumb">

      <li><a href="#"><i class="fa fa-dashboard"></i> Accueil</a></li>

      <li class=""><a  href="<?= site_url('administrator/project_proforma'); ?>">Vérification du Proforma</a></li>

      <li class="active"><?//= cclang('detail'); ?></li>

   </ol>

</section>
<style type="text/css">
  #myUL {
    /* Remove default list styling */
    list-style-type: none;
    padding: 0;
    margin: 0;
  }
  #myUL li a {
    border: 1px solid #ddd; /* Add a border to all links */
    margin-top: -1px; /* Prevent double borders */
    background-color: #f6f6f6; /* Grey background color */
    padding: 12px; /* Add some padding */
    text-decoration: none; /* Remove default text underline */
    font-size: 18px; /* Increase the font-size */
    color: black; /* Add a black text color */
    display: block; /* Make it into a block element to fill the whole list */
  }
  
  #myUL li a:hover:not(.header) {
    background-color: #eee; /* Add a hover effect to all links, except for headers */
  }
</style>
<!-- Main content -->

<section class="content">

  <?php
/*
   $project=$this->uri->segment(4);

   $client=$this->uri->segment(5);*/
 ?> 

   <div class="row" >

     

      <div class="col-md-12">

         <div class="box box-warning">

            <div class="box-body ">



               <!-- Widget: user widget style 1 -->

               <div class="box box-widget widget-user-2">

                 

                  <div class="form-horizontal" name="form_project_proforma" id="form_project_proforma" >

                     <?= form_open('', [

                            'name'    => 'form_list_proforma', 

                            'class'   => 'form-horizontal', 

                            'id'      => 'form_list_proforma', 

                            'enctype' => 'multipart/form-data', 

                            'method'  => 'POST'

                            ]); ?>

                <div class="content">

                     <div class="row">


                                      <?php

$this->db->select('*');
$this->db->from('pos_ibi_clients as c');
$this->db->join('pos_store_2_ibi_devis as d', 'c.ID_CLIENT = d.REF_CLIENT_DEVIS');
$this->db->where('ID_DEVIS',$this->uri->segment(4));

$query = $this->db->get();

   foreach ($query->result() as $row)  //Iterate through results
   {
      $nom = $row->NOM_CLIENT;
      $prenom = $row->PRENOM_CLIENT;
      $address = $row->ADRESSE_CLIENT;
      $email = $row->EMAIL_CLIENT;
      $telephone = $row->TEL_CLIENT;
      $nif = $row->STATE_CLIENT;
      $client=$row->REF_CLIENT_DEVIS;
      //$created_by = $order[ 'order' ][0][ 'AUTHOR' ];
     
   }

?> 

                   <div class="col-md-6">

                     <div class="breadcumb pull-left">
                       <span>Client : </span>
        <div style="margin: 0px 2px 0px 0px;">
          <span class="bold">● <?php echo $nom.' '.$prenom;?></span>
        </div> 
        <div style="margin: 0px 2px 0px 0px;">
          <span>● Bujumbura-BURUNDI</span>
        </div>
        
        <div>
          <span style="margin: 0px 2px 0px 0px;">● Tel : <?php echo $telephone?></span><br>
          <span style="margin: 0px 2px 0px 0px;">● Email : <?php echo $email?></span>
        </div>
        <div>
          <span style="margin: 0px 2px 0px 0px;">● NIF : <?php echo $nif?></span>
        </div>
                     </div>
                     
                   </div>

                   <div class="col-md-6">

                    <div class="pull-right"><b>Date :</b><?php echo date("d-m-Y").' '.'<br/>'; ?></div>

                    
                        

                       <!--  <br/><input type="text" class="form-control col-sm-8 pull-right" name="reference" id="reference" placeholder="Ajouter n°  de reference" value=""> -->
                       
                    
                   </div>

            
                   
                 </div>

       
<br><br>   


               <input type="hidden" class="form-control" name="id_devis" value="<?php echo $this->uri->segment(4); ?>"> 
               <input type="hidden" class="form-control" name="client" value="<?php echo $client; ?>">

                       <div class="form-group ">
                            <label for="TITRE_FICHE" class="col-sm-2 control-label">Titre proforma 
                            <i class="required">*</i>
                            </label>
                            <div class="col-sm-8">
                            
                                <input type="text" class="form-control" name="titre_proforma" id="TITRE_FICHE" placeholder="Entrer un titre pour proforma" value="">
                                <small class="info help-block">
                                </small>
                            </div>
                        </div>





               
                       <div class="form-group ">
                            <label for="quantite" class="col-sm-2 control-label">Quantité
                            <i class="required">*</i>
                            </label>
                            <div class="col-sm-8">
                              <input type="number" class="form-control" name="quantitee" id="quantite" placeholder="Entrer quantité à produire" value="">
                                <small class="info help-block">
                                </small>
                            </div>
                        </div>


   <div class="form-group ">  

                   

                    



<?php

$this->db->select('REF_PRODUCT_CODEBAR_DEVIS_PROD,QUANTITE_DEVIS_PROD,UNIT_DEVIS_PROD,PRIX_DEVIS_PROD,NAME_DEVIS_PROD,TOTAL_FINAL_DEVIS');

$this->db->from('pos_store_2_ibi_devis pd');

$this->db->join('pos_store_2_ibi_devis_produits as d', 'pd.ID_DEVIS = d.REF_DEVIS_CODE_DEVIS_PROD');

$this->db->where('REF_DEVIS_CODE_DEVIS_PROD',$this->uri->segment(4));

$query = $this->db->get();

$total_prices=0;
   foreach ($query->result() as $request)  //Iterate through results
   {



                        $total_price1=($request->QUANTITE_DEVIS_PROD * $request->PRIX_DEVIS_PROD);

                            $total_prices +=$total_price1;

                          $total_proforma = $request->TOTAL_FINAL_DEVIS;


                         ?>




                            <input type="hidden" class="form-control" name="design[]" id="design" placeholder="Design" value="<?php echo $request->NAME_DEVIS_PROD; ?>">

                         <input type="hidden" class="form-control" name="reference[]" id="reference" placeholder="Reference" value="<?php echo $request->REF_PRODUCT_CODEBAR_DEVIS_PROD; ?>">


                          
                          <input type="hidden" class="form-control" name="quantite[]" id="quantite" placeholder="Quantite" value="<?php echo $request->QUANTITE_DEVIS_PROD; ?>">

                           <input type="hidden" class="form-control unit_price" name="unit_price[]" id="unit_price" idprix="<?php echo $request->NAME_DEVIS_PROD;?>" prixRest="<?php echo $request->PRIX_DEVIS_PROD; ?>" placeholder="Prix de vente" min="<?php echo $request->PRIX_DEVIS_PROD; ?>" value="<?php echo $request->PRIX_DEVIS_PROD; ?>">



                           <input type="hidden" class="form-control" name="total_price[]" readonly id="total_price" value="<?php echo ($total_price1); ?>">

                          

                        <?php 
                         
                     } 




$total_proforma_tva  = ($total_proforma * 18) / 100;

$total_proforma_tvac = $total_proforma_tva + $total_proforma;


  
                 ?>
             
                 

                                  
        </div>


<div class="row">
  <div class="col-md-8 pull-right">
     <table  border="0" style="width: 100%" class="table">
                 <tbody>
                        <tr>

                            <td style="text-align: right;"><b>Total HTVA</b></td>
                            <td style="text-align: center;"><b><?php echo number_format(round($total_proforma),0," "," ").'FBU'; ?></b>
                              &nbsp; &nbsp; 
                            <a data-toggle="modal" title="Ajouter une remise" data-target="#remiseId"class="btn btn-primary btn-xs"> <i class="fa fa-edit"></i> </a><input type="hidden" value="<?php echo $total_proforma; ?>" name="total">
                          </td>
                            
                          </tr>

                      <tr>
                       <td style="text-align: right;"><b>TVA (18%)</b></td>
              <td style="text-align: center;"><b><?php echo number_format(round($total_proforma_tva),0," "," ").'FBU' ; ?></b></td>

                      </tr>

                      <tr>
                         <td style="text-align: right;"><b>TVAC</b></td>
                         <td style="text-align: center;"><b><?php echo number_format(round($total_proforma_tvac),0," "," ").'FBU' ; ?></b></td>

                      </tr>

                      </tbody>
                    
                   </table>



</div>
</div>







                    <div class="message"></div>

                   <div class="row-fluid col-md-7">

                           <!-- <button class="btn btn-flat btn-primary btn_save btn_action" id="btn_save" data-stype='stay' title="<?= cclang('save_button'); ?> (Ctrl+s)">

                            <i class="fa fa-save" ></i> <?= cclang('save_button'); ?>

                            </button> -->

                            
                            <button class="btn btn-flat btn-primary btn_save btn_action btn_save_back" type="submit" id="btn_save" data-stype='back' title="Créer un proforma">

                            <i class="fa fa-save" ></i> Enregistrer

                            </button>

                            <a class="btn btn-flat btn-default btn_action" id="btn_cancel" title="<?= cclang('cancel_button'); ?> (Ctrl+x)">

                            <i class="fa fa-undo" ></i> Retour

                            </a>

                            <span class="loading loading-hide">

                            <img src="<?= BASE_ASSET; ?>/img/loading-spin-primary.svg"> 

                            <i><?= cclang('loading_saving_data'); ?></i>

                            </span>

                        </div>

                        <br>

                      </div>







          <div class="modal fade" id="remiseId">
                  <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                          <h4 class="text-center">Appliquer une remise : <span id="discount_type"><span class="label label-primary">au pourcentage</span></span></h4>
                          <span id="discount_price" style="display: none"></span>
                          <span id="discount_initial" style="display: none"></span>
                          <span id="discount_idart" style="display: none"></span>
                          <input type="hidden" class="discount_idart">
                          <div class="input-group input-group-lg">
                            <span class="input-group-btn">
                              <button class="btn btn-default percentage_discount active" id="percentage_discount" type="button">Pourcentage</button>
                            </span>
                            <input type="number" name="remise" class="form-control discount_value" id="discount_value" value="0" placeholder="Définir le montant ou le pourcentage ici...">
                            <span class="input-group-btn">
                              <button class="btn btn-default flat_discount" id="flat_discount" type="button">Espèces
                                <input type="hidden" value="" name="type_remize" id="type_remize"></button>
                            </span>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                          <button type="button" class="btn btn-primary" onclick="save_discount(this);">OK</button>
                          <!-- <button type="button" class="btn btn-primary save_discount">OK</button> -->
                        </div>
                      </div>
                    </div>
                  </div>












                     <?= form_close(); ?>

                  </div>

               </div>

            </div>

            <!--/box body -->

         </div>

         <!--/box -->



      </div>

   </div>

</section>


<!-- /.content -->

<script>

    $(document).ready(function(){

     /* qte=$('.quantite1_').val();

        price=$('.unit_price1_').val();
        prix=qte*price;

        $('.total_price1_').val(prix);*/

         

      $('#btn_cancel').click(function(){

        swal({

            title: "Annuler !",

            text: "Le proforma ne sera pas créé!",

            type: "warning",

            showCancelButton: true,

            confirmButtonColor: "#DD6B55",

            confirmButtonText: "Oui!",

            cancelButtonText: "Non!",

            closeOnConfirm: true,

            closeOnCancel: true

          },

          function(isConfirm){

            if (isConfirm) {

              window.location.href = BASE_URL + 'administrator/pos_store_2_ibi_devis';

            }

          });

    

        return false;

      }); /*end btn cancel*/



      $('.btn_save').click(function(){

        avoid_multi_click_btn('btn_save', 15000);

        $('.message').fadeOut();

            

        var form_project = $('#form_list_proforma');

        var data_post = form_project.serializeArray();

        var save_type = $(this).attr('data-stype');



        data_post.push({name: 'save_type', value: save_type});

    

        $('.loading').show();

    

        $.ajax({

          url: BASE_URL + '/administrator/pos_store_2_ibi_proforma/add_save',

          type: 'POST',

          dataType: 'json',

          data: data_post,

        })




        .done(function(res) {

          if(res.success) {

            

            if (save_type == 'back') {

              window.location.href = res.redirect;

              return;

            }

    

            $('.message').printMessage({message : res.message});

            $('.message').fadeIn();

            resetForm();

            $('.chosen option').prop('selected', false).trigger('chosen:updated');

                

          } else {

            $('.message').printMessage({message : res.message, type : 'warning'});

          }

    

        })



        .fail(function() {

          $('.message').printMessage({message : 'Error save data', type : 'warning'});

        })

        .always(function() {

          $('.loading').hide();

          $('html, body').animate({ scrollTop: $(document).height() }, 2000);

        });

     /* }

   });*/
    

        return false;



      }); /*end btn save*/


    }); /*end doc ready*/

function avoid_multi_click_btn(btn_id, period)
  {
      $('#'+btn_id).attr('disabled', true);

      var my_interval = setInterval(function(){

        $('#'+btn_id).attr('disabled', false);

        clearInterval(my_interval);

      }, period);
  }

</script>


</script>

<script type="text/javascript">
  function getRidOfTheComma(data){
      var toReturn = "";
      var toFilter = data.split("");
      const toMakeString = toFilter.filter(element => element !== ",");
      const times = toMakeString.length;
      for(i=0; i<times; i++){
          toReturn += toMakeString[i];
      }
      return toReturn;
  }

  function stringToNumber(data){
      var toReturn = 0;
      var toMakeInt = "";
      if(data === ""){
          return toReturn;
      } else {
          toMakeInt = getRidOfTheComma(data);
          toReturn = parseFloat(toMakeInt);
          return toReturn;
      }
  }
  function toRemise(data){
    $("#remiseId").modal();
    const initial = stringToNumber($(data).closest('tr').find('td div input').val());
    const price = stringToNumber($(data).closest('tr').find('td.price').text());
    const idart = ($(data).closest('tr').attr('id'));
   
    document.getElementById('discount_price').innerHTML = price;
    document.getElementById('discount_initial').innerHTML = initial;
    // document.getElementById('discount_idart').innerHTML = idart;
    $('.discount_idart').val(idart);
  }
  function save_discount(data){
       const discount_type = document.getElementById("discount_type").innerHTML;
       const discount_price = document.getElementById("discount_price").innerHTML;
       const discount_initial = document.getElementById("discount_initial").innerHTML;
       // const discount_idart = document.getElementById("discount_idart").innerHTML;
       const discount_idart = $('.discount_idart').val();
       const discount_value = $('.discount_value').val();

      if(discount_type == 'Espèces'){
      
        // if(discount_value = discount_price){
        //       alert('La remise fixe ne peut pas excéder la valeur actuelle du panier. Le montant de la remise à été réduite à la valeur du panier.');
        //       document.getElementById('remise'+discount_idart+'').innerHTML = discount_price;
        //       $('#remiseId').modal('hide');
        // }else 
        if(discount_value == ''){
                // document.getElementById('remise'+discount_idart+'').innerHTML = 0;
                $('#remise'+discount_idart+'').text(0);
                $('.remise'+discount_idart+'').val(0);
                $('#remiseId').modal('hide');
          }else{
           const price = discount_price * discount_initial - discount_value;
           // document.getElementById('remise'+discount_idart+'').innerHTML = discount_value;
           $('#remise'+discount_idart+'').text(discount_value);
           $(data).closest('tr').find('td.total').text(price);
           $('.remise'+discount_idart+'').val(discount_value);
           $('#remiseId').modal('hide');
        }
           
        }else if(discount_type == 'Pourcentage'){
          if(discount_value>100){
                // document.getElementById('remise'+discount_idart+'').innerHTML = 100+'%';
                $('#remise'+discount_idart+'').text(100+'%');
                $('.remise'+discount_idart+'').val(100+'%');
                $('#remiseId').modal('hide');
          }else if(discount_value == ''){
                $('#remise'+discount_idart+'').text(0+'%');
                $('.remise'+discount_idart+'').val(0+'%');
                $('#remiseId').modal('hide');
          }else{
               // document.getElementById('remise'+discount_idart+'').innerHTML = discount_value+'%';
               $('#remise'+discount_idart+'').text(discount_value+'%');
               $('.remise'+discount_idart+'').val(discount_value+'%');
               $('#remiseId').modal('hide');
          }
           
        }else{
          if(discount_value>100){
                // document.getElementById('remise'+discount_idart+'').innerHTML = 100+'%';
                $('#remise'+discount_idart+'').text(100+'%');
                $('.remise'+discount_idart+'').val(100+'%');
                $('#remiseId').modal('hide');
          }else if(discount_value == ''){
                $('#remise'+discount_idart+'').text(0+'%');
                $('.remise'+discount_idart+'').val(0+'%');
                $('#remiseId').modal('hide');
          }else{
               // document.getElementById('remise'+discount_idart+'').innerHTML = discount_value+'%';
               $('#remise'+discount_idart+'').text(discount_value+'%');
               $('.remise'+discount_idart+'').val(discount_value+'%');
               $('#remiseId').modal('hide');
          }
        }
    }
  function toDelete(data){
    $(data).closest('tr').remove();
    const idex = articleTable.indexOf($(data).closest('tr').attr("id"));
    articleTable.splice(idex, 1);
  }
  function moins(data){
    const initial = stringToNumber($(data).closest('tr').find('td div input').val());
    const price = stringToNumber($(data).closest('tr').find('td.price').text());
    const qty = initial - 1;
    if(qty <= 0){
      $(data).closest('tr').remove();
      const idex = articleTable.indexOf($(data).closest('tr').attr("id"));
      articleTable.splice(idex, 1);
    } else {
      $(data).closest('tr').find('td div input').val(qty);
      $(data).closest('tr').find('td.total').text(price * qty);
    }
  }

  function plus(data){
    const initial = stringToNumber($(data).closest('tr').find('td div input').val());
    const price = stringToNumber($(data).closest('tr').find('td.price').text());
    const qty = initial + 1;
  
    $(data).closest('tr').find('td div input').val(qty);
    $(data).closest('tr').find('td.total').text(price * qty);


  }
  function search(data){
    const quantRest = $(data).closest('tr').find("td.quantRest").text();
    const initial = stringToNumber($(data).closest('tr').find('td div input').val());
    const price = stringToNumber($(data).closest('tr').find('td.price').text());
 
      $(data).closest('tr').find('td div input').val(initial);
      $(data).closest('tr').find('td.total').text(price * initial);
    
    }

    $(document).ready(function(){

      
      $('.flat_discount').on('click',function(){
        document.getElementById('discount_type').innerHTML = 'Espèces';

        $(this).find('input[name=type_remize]').val('espece');

      });
      $('.percentage_discount').on('click',function(){
        document.getElementById('discount_type').innerHTML = 'Pourcentage';
      });

      $('#temps').on('change',function(){
             var temps =$('#temps').val();
             if(temps===''){
              $('#delai1').hide();$('#delai').show();
             }else{
             $('#delai1').show();
             $('#delai').hide(); }
      });
      $('#condPayer').on('change',function(){
        var condPayer=$('#condPayer').val(); 
        if(condPayer=='1'){
          $('#customer').hide();
        }else{
           $('#customer').show();
        }
            
      });

    var combobox = document.getElementById("combobox");
    var articleOption = document.getElementsByClassName("articleOption");
    
    $("#myInput").on('keyup', function(){
      var input, filter, ul, li, a, i, txtValue;

      input = document.getElementById('myInput');
      filter = input.value.toUpperCase();
      ul = document.getElementById("myUL");
      li = ul.getElementsByTagName('li'); 

      if(input.value === ""){
        $("#list").attr("hidden", 'true');
      } else {
        $("#list").removeAttr("hidden");
        for (i = 0; i < li.length; i++) {
          a = li[i].getElementsByTagName("a")[0];
          txtValue = a.textContent || a.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
          } else {
            li[i].style.display = "none";
          }
        }
      }
    });

    $('.articleOption').on('click',function(){ 

            const code_proforma = $(this).attr("code_proforma");
            const ref_client = $(this).attr("ref_client");
            const store_prefix = $('#store_prefix').val();
            const store_uri = $('#store_uri').val();

            $.ajax({
                url: BASE_URL + '/administrator/registers/generate_commande_post',
                method:'POST',
                data:{code_proforma:code_proforma,ref_client:ref_client,store_prefix:store_prefix,store_uri:store_uri},
                dataType:'json',

                success:function(data){ 
                  $("#list").attr("hidden", 'true');
                  $('#tableProforma').html(data.tableau);
                }
            });
        });

    /*document ready*/
});

</script>
<style type="text/css">
  #myUL {
    /* Remove default list styling */
    list-style-type: none;
    padding: 0;
    margin: 0;
  }
  #myUL li a {
    border: 1px solid #ddd; /* Add a border to all links */
    margin-top: -1px; /* Prevent double borders */
    background-color: #f6f6f6; /* Grey background color */
    padding: 12px; /* Add some padding */
    text-decoration: none; /* Remove default text underline */
    font-size: 18px; /* Increase the font-size */
    color: black; /* Add a black text color */
    display: block; /* Make it into a block element to fill the whole list */
  }
  
  #myUL li a:hover:not(.header) {
    background-color: #eee; /* Add a hover effect to all links, except for headers */
  }
</style>